# Pull base image - using standard Debian ARM64 since jlesage/baseimage-gui doesn't support ARM64
FROM --platform=linux/arm64 debian:11-slim

# Set the name of the application.
ENV APP_NAME="StardewValley"
ENV DISPLAY=:0
ENV VNC_PASSWORD=insecure
ENV DISPLAY_WIDTH=1200
ENV DISPLAY_HEIGHT=900

# Uses the same PATH structure as GOG version
ENV GAME_PATH="/data/Stardew"

# Install dependencies including GUI/VNC components
# SDL2 and OpenAL are required for ValleyCore (native ARM64 Stardew Valley)
RUN apt-get update && apt-get install -y \
    wget unzip tar strace mono-complete xterm gettext-base jq netcat procps locales \
    libsdl2-2.0-0 libopenal1 \
    xvfb x11vnc fluxbox novnc websockify \
    supervisor \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Create directories for VNC and config
RUN mkdir -p /root/.vnc /config/xdg/config/StardewValley/Saves

# VNC password will be set at runtime from environment variable

# Create supervisor config for VNC and noVNC
RUN mkdir -p /etc/supervisor/conf.d && \
    echo '[supervisord]' > /etc/supervisor/conf.d/supervisord.conf && \
    echo 'nodaemon=true' >> /etc/supervisor/conf.d/supervisord.conf && \
    echo 'user=root' >> /etc/supervisor/conf.d/supervisord.conf && \
    echo '' >> /etc/supervisor/conf.d/supervisord.conf && \
    echo '[program:xvfb]' >> /etc/supervisor/conf.d/supervisord.conf && \
    echo 'command=/usr/bin/Xvfb :0 -screen 0 1200x900x24' >> /etc/supervisor/conf.d/supervisord.conf && \
    echo 'autorestart=true' >> /etc/supervisor/conf.d/supervisord.conf && \
    echo 'priority=100' >> /etc/supervisor/conf.d/supervisord.conf && \
    echo '' >> /etc/supervisor/conf.d/supervisord.conf && \
    echo '[program:fluxbox]' >> /etc/supervisor/conf.d/supervisord.conf && \
    echo 'command=/usr/bin/fluxbox' >> /etc/supervisor/conf.d/supervisord.conf && \
    echo 'environment=DISPLAY=":0"' >> /etc/supervisor/conf.d/supervisord.conf && \
    echo 'autorestart=true' >> /etc/supervisor/conf.d/supervisord.conf && \
    echo 'priority=200' >> /etc/supervisor/conf.d/supervisord.conf && \
    echo '' >> /etc/supervisor/conf.d/supervisord.conf && \
    echo '[program:x11vnc]' >> /etc/supervisor/conf.d/supervisord.conf && \
    echo 'command=/usr/bin/x11vnc -forever -shared -rfbport 5900 -display :0 -usepw -noxdamage' >> /etc/supervisor/conf.d/supervisord.conf && \
    echo 'autorestart=true' >> /etc/supervisor/conf.d/supervisord.conf && \
    echo 'priority=300' >> /etc/supervisor/conf.d/supervisord.conf && \
    echo '' >> /etc/supervisor/conf.d/supervisord.conf && \
    echo '[program:novnc]' >> /etc/supervisor/conf.d/supervisord.conf && \
    echo 'command=/usr/bin/websockify --web=/usr/share/novnc/ 5800 localhost:5900' >> /etc/supervisor/conf.d/supervisord.conf && \
    echo 'autorestart=true' >> /etc/supervisor/conf.d/supervisord.conf && \
    echo 'priority=400' >> /etc/supervisor/conf.d/supervisord.conf

# Create directory structure
RUN mkdir -p ${GAME_PATH}/game && \
    mkdir -p /data/nexus && \
    mkdir -p /opt/valleycore

# Download ValleyCore for native ARM64 Stardew Valley support
# ValleyCore patches the game DLL to work with ARM64 .NET runtime
RUN VALLEYCORE_VERSION="v1.6.15b" && \
    wget -qO /tmp/valleycore.tar.gz "https://github.com/a9ix/ValleyCore/releases/download/${VALLEYCORE_VERSION}/ValleyCore.tar.gz" && \
    tar -xzf /tmp/valleycore.tar.gz -C /opt/valleycore && \
    rm /tmp/valleycore.tar.gz && \
    chmod +x /opt/valleycore/patch.sh && \
    chmod +x /opt/valleycore/smapi-wrapper.sh 2>/dev/null || true

# Install .NET SDK 5.0.408 for ARM64 (for SMAPI and mods)
RUN wget -qO dotnet.tar.gz https://download.visualstudio.microsoft.com/download/pr/d4b71fac-a2fd-4516-ac58-100fb09d796a/e79d6c2a8040b59bf49c0d167ae70a7b/dotnet-sdk-5.0.408-linux-arm64.tar.gz &&\
     tar -zxf dotnet.tar.gz -C /usr/share/dotnet &&\
     rm dotnet.tar.gz &&\
     ln -s /usr/share/dotnet/dotnet /usr/bin/dotnet

# Download and install SMAPI
# Note: SMAPI installation will happen at runtime after game binary is mounted
# This prepares the installer for later use
RUN wget --user-agent="Mozilla" https://github.com/Pathoschild/SMAPI/releases/download/4.1.10/SMAPI-4.1.10-installer.zip -qO /data/nexus.zip && \
    unzip /data/nexus.zip -d /data/nexus/ && \
    rm /data/nexus.zip

# Add Mods & Scripts
COPY ["docker/mods/", "/data/Stardew/game/Mods/"]
COPY docker/scripts/ /opt/

# Set permissions (game binary will be mounted later, so we set permissions on directories)
RUN chmod -R 777 /data/Stardew/ && \
    chown -R 1000:1000 /data/Stardew && \
    chmod +x /opt/*.sh

# Setup utils service (for compatibility with original structure)
# Note: run file is optional - create it if it doesn't exist
RUN mkdir -p /etc/services.d/utils /etc/services.d/app && \
    touch /etc/services.d/app/utils.dep || true
COPY docker/run /etc/services.d/utils/run
RUN chmod +x /etc/services.d/utils/run

# Copy entrypoint script
COPY docker/docker-entrypoint-arm.sh /startapp.sh
RUN chmod +x /startapp.sh

# Set working directory
WORKDIR /data/Stardew/game

# Expose ports
EXPOSE 5900 5800

# Start supervisor and entrypoint
CMD ["/bin/bash", "-c", "supervisord -c /etc/supervisor/conf.d/supervisord.conf & /startapp.sh"]

